---
title: "Sensitivity Analysis: Arbitrary User Function"
date: "2025-01-25"
output:
  html_document:
    fig.align: "center"
    toc: true
    number_sections: false
bibliography: references.bib
csl: apa.csl
---



# Goal

This article illustrates how to
identify cases that are influential
on an arbitrary statistics computed
by any function, using
the [`semfindr`](https://sfcheung.github.io/semfindr/) package
.

Readers are assumed to have a basic
understanding on how to use `lavaan_rerun()`,
as illustrated in [this article](https://sfcheung.github.io/semfindr/articles/semfindr.html).

# Dataset and Model

The sample dataset `HolzingerSwineford1939`
from the `lavaan` package will be used
for illustration.


``` r
library(semfindr)
library(lavaan)
head(HolzingerSwineford1939)
#>   id sex ageyr agemo  school grade       x1   x2    x3       x4   x5        x6
#> 1  1   1    13     1 Pasteur     7 3.333333 7.75 0.375 2.333333 5.75 1.2857143
#> 2  2   2    13     7 Pasteur     7 5.333333 5.25 2.125 1.666667 3.00 1.2857143
#> 3  3   2    13     1 Pasteur     7 4.500000 5.25 1.875 1.000000 1.75 0.4285714
#> 4  4   1    13     2 Pasteur     7 5.333333 7.75 3.000 2.666667 4.50 2.4285714
#> 5  5   2    12     2 Pasteur     7 4.833333 4.75 0.875 2.666667 4.00 2.5714286
#> 6  6   2    14     1 Pasteur     7 5.333333 5.00 2.250 1.000000 3.00 0.8571429
#>         x7   x8       x9
#> 1 3.391304 5.75 6.361111
#> 2 3.782609 6.25 7.916667
#> 3 3.260870 3.90 4.416667
#> 4 3.000000 5.30 4.861111
#> 5 3.695652 6.30 5.916667
#> 6 4.347826 6.65 7.500000
```

A confirmatory factor analysis model
is to be fitted to the items `x1`
to `x9`:


``` r
mod <-
"
visual =~ x1 + x2 + x3
textual =~ x4 + x5 + x6
speed =~ x7 + x8 + x9
"
fit <- cfa(model = mod,
           data = HolzingerSwineford1939)
```

# Leave-One-Out (LOO) Results

We first do LOO analysis first, fitting
the model *n* times, *n* being the number
of cases, each time with one case removed:


``` r
fit_rerun <- lavaan_rerun(fit)
#> The expected CPU time is 9.03 second(s).
#> Could be faster if run in parallel.
```

# Case Influence on Any Statistic

The function `user_change_raw()` can be
use to compute case influence measure
for any statistics as long as it is
provided a function that:

- accepts a `lavaan` object (e.g., the
  output of `lavaan::cfa()` or
  `lavaan::sem()`) as the first argument.

- returns a named numeric vector of the
  statistics.

Different scenarios will be illustrated
below.

## Reliability

Suppose we are interested in the
reliability of the three factors.
They can be computed by `compRelSEM()`
from `semTools`:


``` r
library(semTools)
fit_rel <- compRelSEM(fit)
fit_rel
#>  visual textual   speed 
#>   0.612   0.885   0.686
```

We can compute the influence of each
case using `user_change_raw()`:


``` r
influence_rel <- user_change_raw(fit_rerun,
                                 user_function = compRelSEM)
```

The first argument is the output of
`lavaan_rerun()`.

The argument `user_function` is the
argument used to compute the statistics.

The output is an `est_change` object:


``` r
influence_rel
#> 
#> -- Case Influence on User Function --
#> 
#>     id visual  id textual  id  speed
#> 1  268 -0.009 262  -0.003 140  0.012
#> 2   71  0.009 113  -0.002 194  0.010
#> 3  223  0.008 267   0.002 240  0.009
#> 4   47  0.008  53   0.002 209  0.008
#> 5  143  0.008 194   0.002  78 -0.007
#> 6  105  0.008   1  -0.002 152  0.007
#> 7   67 -0.007 254  -0.002 192 -0.007
#> 8  163  0.007 217   0.002 205  0.007
#> 9   72 -0.007 252   0.002  69 -0.006
#> 10 107 -0.007 105  -0.002  34 -0.006
#> 
#> Note:
#> - Changes are raw changes if a case is included.
#> - Only the first 10 case(s) is/are displayed. Set 'first' to NULL to display all cases.
#> - Cases sorted by the absolute changes for each variable.
```

The influence is computed by:

- (User statistic with all case) - (User statistic without this case).

Therefore, if the value is positive for
a case, the statistic, reliability in
this case, is larger if this case is
included.

Conversely, if the value is negative
for a case, the statistic is decreases
if this case is included.

The function `index_plot()` can be used
to visualize the influence. For example,
this is the plot of case influence on
the reliability of `visual`.

![Case Influence on Reliability](user_fun-1.png)

The output is a `ggplot` object,
`column` needs to be set to the name
of the statistic to be plotted.
Refer to the help page of `index_plot()`
for other arguments available.

# Final Remarks


# Reference
